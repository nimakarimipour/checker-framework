\htmlhr
\chapterAndLabel{Returns Receiver Checker}{returns-receiver-checker}

The Returns Receiver Checker enables documenting and checking that a method
returns its receiver (i.e., the \<this> parameter).

There are two ways to run the Returns Receiver Checker.
\begin{itemize}
\item
Typically, it is automatically run by another checker.
\item
Alternately, you can run just the Returns Receiver Checker, by
supplying the following command-line options to javac:
\code{-processor org.checkerframework.common.returnsrcvr.ReturnsRcvrChecker}
\end{itemize}


\sectionAndLabel{Annotations}{returns-receiver-checker-annotations}

\begin{figure}
    \begin{Verbatim}
    class NameBuilder {
        String firstName, lastName;
        @This NameBuilder setFirstName(String firstName) {
            this.firstName = firstName;
            return this;
        }
        @This NameBuilder setLastName(String lastName) {
            this.lastName = lastName;
            return this;
        }
        Name build() { return new Name(firstName, lastName); }
    }
    \end{Verbatim}
    \caption{Example usage of \refqualclass{common/returnsrcvr/qual}{This} annotation.}
    \label{fig-this-annot-example}
\end{figure}

The type annotation \refqualclass{common/returnsrcvr/qual}{This} on the return
type of a method indicates that the method returns its receiver. As an example,
Figure~\ref{fig-this-annot-example} shows a builder class in which
\refqualclass{common/returnsrcvr/qual}{This} is used to specify that the
\<setFirstName> and \<setLastName> methods return their receiver.  An
\refqualclass{common/returnsrcvr/qual}{This} annotation can only be written on
the return type of a method or in a downcast; if written elsewhere, the checker
will emit an \code{[invalid.this.location]} warning.

The qualifier hierarchy and type-checking approach for the Returns Receiver
Checker are both somewhat unusual.  As is standard, the Returns Receiver
Checker has a top qualifier,
\refqualclass{common/returnsrcvr/qual}{MaybeThis}, and a bottom qualifier,
\refqualclass{common/returnsrcvr/qual}{BottomThis}.  However, \refqualclass{common/returnsrcvr/qual}{This}
is \emph{not} a subtype of \refqualclass{common/returnsrcvr/qual}{MaybeThis},
but instead a polymorphic qualifier.  While polymorphic qualifiers are typically
used to allow a method to have multiple qualified type signatures (see
Section~\ref{qualifier-polymorphism}), here polymorphism is used to equate a
method's return and receiver type qualifier.  When the checker observes an
\refqualclass{common/returnsrcvr/qual}{This} annotation on a method return type,
it proceeds to automatically add \refqualclass{common/returnsrcvr/qual}{This} to
the method's receiver type. The presence of
\refqualclass{common/returnsrcvr/qual}{This} on both the method's return and
receiver type forces their type qualifiers to be \emph{equal}.  Hence, the
method will only pass the type checker if it returns its receiver argument,
achieving the desired checking.

\sectionAndLabel{AutoValue and Lombok Support}{returns-receiver-checker-autovalue-lombok-support}

\begin{figure}
    \begin{Verbatim}
    @AutoValue
    abstract class Animal {
        abstract String name();
        abstract int numberOfLegs();
        static Builder builder() {
            return new AutoValue_Animal.Builder();
        }
        @AutoValue.Builder
        abstract static class Builder {
            abstract @This Builder setName(String value);
            abstract @This Builder setNumberOfLegs(int value);
            abstract Animal build();
        }
    }
    \end{Verbatim}
    \caption{An illustrative use of the \<@AutoValue.Builder> annotation.
    Given this code, AutoValue automatically generates a concrete subclass of
    \<Animal.Builder> (see Figure~\ref{fig-autovalue-builder-generated}).  The <@This> annotations on the setters in
    \<Builder> are automatically added by the Returns Receiver Checker.}
    \label{fig-autovalue-builder}
\end{figure}

\begin{figure}
    \begin{Verbatim}
    class AutoValue_Animal {
        static final class Builder extends Animal.Builder {
            private String name;
            private Integer numberOfLegs;
            @This Animal.Builder setName(String name) {
              this.name = name;
              return this;
            }
            @This Animal.Builder setNumberOfLegs(int numberOfLegs) {
              this.numberOfLegs = numberOfLegs;
              return this;
            }
            @Override
            Animal build() {
              return new AutoValue_Animal(
                  this.name,
                  this.numberOfLegs);
            }
          }
    }
    \end{Verbatim}
    \caption{Code generated by AutoValue for the example of
    Figure~\ref{fig-autovalue-builder}, including the \<@This> annotations added
    by the Returns Receiver Checker.}
    \label{fig-autovalue-builder-generated}
\end{figure}

For programs using builder generation support from
\href{https://github.com/google/auto/tree/master/value}{AutoValue} or
\href{https://projectlombok.org/}{Project Lombok}, the Returns Receiver Checker
will automatically inject \refqualclass{common/returnsrcvr/qual}{This}
annotations on the return types of the fluent API methods of generated builders.
Consider the code using AutoValue in Figure~\ref{fig-autovalue-builder}.  For
this code, AutoValue automatically generates a class
\<AutoValue\_Animal.Builder> that extends \<Animal.Builder> and implements its
abstract methods.  The Returns Receiver Checker automatically adds a
\refqualclass{common/returnsrcvr/qual}{This} annotation to the return type of
\<Animal.Builder.setName> and \<Animal.Builder.setNumberOfLegs>, and also to the
return types of those methods in the generated subclass.  The Returns Receiver
Checker still runs to ensure the implementation of the generated subclass is
consistent with the injected annotations.  Project Lombok Builders are supported
in a similar fashion.

To disable the checker's built-in framework support, use the
\<-AdisableFrameworkSupport> command-line option, passing a list of frameworks
whose support should be disabled.  For example, to disable both AutoValue and
Lombok support, pass \<-AdisableFrameworkSupport=AutoValue,Lombok>.
